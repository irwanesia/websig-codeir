<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Kantor BPN Seluruh Indonesia</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/2.3.7/css/dataTables.bootstrap5.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --light-color: #ecf0f1;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            z-index: 999;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color) !important;
        }
        
        .navbar-brand i {
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/" style="color: #f8f9fa !important;">
                <i class="bi bi-geo-alt-fill me-2"></i>
                WebGIS Kantor BPN Seluruh Indonesia            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/" data-page="home">
                        <i class="bi bi-map me-1"></i> Peta
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.php" data-page="about">
                        <i class="bi bi-info-circle me-1"></i> Tentang
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#helpModal" data-page="help">
                        <i class="bi bi-question-circle me-1"></i> Bantuan
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" 
                    data-bs-toggle="dropdown" data-page="admin">
                        <i class="bi bi-gear me-1"></i>Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/admin.php" data-page="admin-kelola"><i class="bi bi-file-earmark-text me-2"></i>Kelola Data Kantor</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportToCSV()" data-page="admin-export"><i class="bi bi-box-arrow-up me-2"></i>Export CSV</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/admin.php?logout=1" data-page="admin-logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </li>
            </ul>
            </div>
        </div>
    </nav>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-question-circle me-2"></i>Panduan Penggunaan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Fitur-fitur WebGIS BPN:</h6>
                    <ul>
                        <li><strong>Pencarian:</strong> Cari kantor berdasarkan nama, alamat, atau kota</li>
                        <li><strong>Filter:</strong> Filter kantor berdasarkan provinsi dan jenis kantor</li>
                        <li><strong>Layer Peta:</strong> Ganti tampilan peta dasar sesuai kebutuhan</li>
                        <li><strong>Lokasi Saat Ini:</strong> Tampilkan lokasi Anda saat ini di peta</li>
                        <li><strong>Export Data:</strong> Ekspor data kantor ke format CSV</li>
                        <li><strong>Rute:</strong> Cari rute dari lokasi Anda ke kantor BPN</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
<!-- Main Content -->
<main class="container-fluid px-4 py-3">
    <div class="row g-4">
        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-filter me-2"></i>Filter & Pencarian</h5>
                </div>
                <div class="card-body">
                    <!-- Search Box -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Cari Kantor BPN:</label>
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Nama, alamat, kota...">
                            <button class="btn btn-primary" id="searchBtn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter Provinsi -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Provinsi:</label>
                        <select id="provinceFilter" class="form-select">
                            <option value="">Semua Provinsi</option>
                            <!-- Options akan diisi oleh JavaScript -->
                        </select>
                    </div>
                    
                    <!-- Filter Jenis Kantor -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Jenis Kantor:</label>
                        <select id="officeTypeFilter" class="form-select">
                            <option value="">Semua Jenis</option>
                            <option value="Kantor Wilayah">Kantor Wilayah</option>
                            <option value="Kantor Pertanahan">Kantor Pertanahan</option>
                            <option value="Kantor Pelayanan">Kantor Pelayanan</option>
                        </select>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-success" id="resetBtn">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset Filter
                        </button>
                        <button class="btn btn-outline-primary" id="currentLocationBtn">
                            <i class="bi bi-geo-alt me-2"></i>Lokasi Saya
                        </button>
                        <button class="btn btn-outline-success" id="exportBtn">
                            <i class="bi bi-download me-2"></i>Export CSV
                        </button>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="fw-semibold"><i class="bi bi-bar-chart me-2"></i>Statistik</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stat-box bg-light p-2 rounded">
                                    <h4 class="mb-0" id="totalOffices">0</h4>
                                    <small class="text-muted">Total Kantor</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box bg-light p-2 rounded">
                                    <h4 class="mb-0" id="visibleOffices">0</h4>
                                    <small class="text-muted">Tampil</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Layers -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-layers me-2"></i>Layer Peta</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="mapLayer" 
                               id="layerOSM" value="osm" checked>
                        <label class="form-check-label" for="layerOSM">
                            OpenStreetMap Standard
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="mapLayer" 
                               id="layerTopo" value="topo">
                        <label class="form-check-label" for="layerTopo">
                            Topografi
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="mapLayer" 
                               id="layerSatellite" value="satellite">
                        <label class="form-check-label" for="layerSatellite">
                            Satellite
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Map Area -->
        <div class="col-lg-9">
            <!-- Map Header -->
            <div class="card shadow-sm mb-3">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-0 text-primary">
                                <i class="bi bi-geo-alt me-2"></i>
                                Peta Kantor BPN Seluruh Indonesia
                            </h4>
                            <p class="text-muted mb-0" id="mapInfo">
                                <span class="badge bg-success">
                                    <i class="bi bi-circle-fill me-1"></i>
                                    OpenStreetMap
                                </span>
                                <span class="ms-2" id="loadingStatus">Memuat data...</span>
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" id="zoomInBtn">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                                <button class="btn btn-outline-primary" id="zoomOutBtn">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <button class="btn btn-outline-primary" id="fullExtentBtn">
                                    <i class="bi bi-fullscreen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="card shadow-sm">
                <div class="card-body p-0 position-relative">
                    <div id="map" style="height: 600px; border-radius: 0.375rem;"></div>
                    
                    <!-- Loading Overlay -->
                    <div id="mapLoading" class="map-loading-overlay">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Memuat peta...</p>
                    </div>
                    
                    <!-- Map Controls -->
                    <div class="map-controls" style="margin-top: 50px;">
                        <div class="btn-group-vertical shadow-sm">
                            <button class="btn btn-light" id="locateBtn" title="Lokasi Saya">
                                <i class="bi bi-geo"></i>
                            </button>
                            <button class="btn btn-light" id="routeBtn" title="Cari Rute">
                                <i class="bi bi-signpost"></i>
                            </button>
                            <button class="btn btn-light" id="legendToggle" title="Legenda">
                                <i class="bi bi-list-ul"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div id="mapLegend" class="map-legend card shadow-sm" style="display: block;">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-palette me-2"></i>Legenda</h6>
                        </div>
                        <div class="card-body">
                            <div class="legend-item mb-2" style="font-size: 12px;">
                                <span class="legend-color" style="background-color: #e74c3c;"></span>
                                <span>Kantor Wilayah (Kanwil)</span>
                            </div>
                            <div class="legend-item mb-2" style="font-size: 12px;">
                                <span class="legend-color" style="background-color: #3498db;"></span>
                                <span>Kantor Pertanahan (Kantah)</span>
                            </div>
                            <div class="legend-item" style="font-size: 12px;">
                                <span class="legend-color" style="background-color: #2ecc71;"></span>
                                <span>Kantor Pusat</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Office List -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-building me-2"></i>
                        Daftar Kantor BPN
                        <span class="badge bg-light text-dark ms-2" id="officeCount">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover table-striped table-bordered mb-0" id="officesTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Nama Kantor</th>
                                    <th>Alamat</th>
                                    <th>Kota/Kab</th>
                                    <th>Telepon</th>
                                    <th>Jenis</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="officeTableBody">
                                <!-- Data akan diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div id="officeLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Memuat data kantor...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Office Detail Modal -->
<div class="modal fade" id="officeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="officeModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-geo-alt me-2"></i>Informasi Kantor</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Alamat</strong></td>
                                <td id="officeAddress"></td>
                            </tr>
                            <tr>
                                <td><strong>Telepon</strong></td>
                                <td id="officePhone"></td>
                            </tr>
                            <tr>
                                <td><strong>Email</strong></td>
                                <td id="officeEmail"></td>
                            </tr>
                            <tr>
                                <td><strong>Jam Operasional</strong></td>
                                <td id="officeHours"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-map me-2"></i>Lokasi</h6>
                        <div id="officeMiniMap" style="height: 200px; border-radius: 0.375rem;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <!-- Pastikan tombol di modal menggunakan onclick dengan benar -->
                <!-- Di modal, pastikan ID-nya modalRouteBtn -->
                <button class="btn btn-primary" id="modalRouteBtn" onclick="window.handleModalRouteClick()">
                    <i class="bi bi-signpost me-2"></i>Cari Rute
                </button>
                <!-- <button class="btn btn-primary" onclick="window.handleModalRouteClick()">
                    <i class="bi bi-signpost me-2"></i>Cari Rute
                </button> -->
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

    <!-- Footer Section -->
    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container">
            <div class="row">
                <!-- About Section -->
                <div class="col-md-4 mb-3">
                    <h5 class="text-uppercase mb-3">
                        <i class="bi bi-geo-alt-fill me-2 text-primary"></i>
                        WebGIS BPN
                    </h5>
                    <p class="small text-white-50">
                        Sistem Informasi Geografis Kantor Badan Pertanahan Nasional 
                        Seluruh Indonesia. Memudahkan pencarian lokasi kantor BPN 
                        dengan peta interaktif.
                    </p>
                </div>
                
                <!-- Quick Links -->
                <div class="col-md-2 mb-3">
                    <h5 class="text-uppercase mb-3">Menu</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="/" class="text-white-50 text-decoration-none">
                                <i class="bi bi-house-door me-2"></i>Beranda
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/about.php" class="text-white-50 text-decoration-none">
                                <i class="bi bi-info-circle me-2"></i>Tentang
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#helpModal" class="text-white-50 text-decoration-none">
                                <i class="bi bi-question-circle me-2"></i>Bantuan
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Statistics -->
                <div class="col-md-3 mb-3">
                    <h5 class="text-uppercase mb-3">Statistik</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-building me-2 text-primary"></i>
                            <span class="text-white-50">Total Kantor: </span>
                            <span class="fw-bold" id="footerTotalOffices">0</span>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-pin-map me-2 text-success"></i>
                            <span class="text-white-50">Provinsi: </span>
                            <span class="fw-bold" id="footerTotalProvinces">0</span>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-arrow-repeat me-2 text-info"></i>
                            <span class="text-white-50">Versi: </span>
                            <span class="fw-bold">1.0.0</span>
                        </li>
                    </ul>
                </div>
                
                <!-- Contact Info -->
                <div class="col-md-3 mb-3">
                    <h5 class="text-uppercase mb-3">Kontak</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="bi bi-envelope me-2 text-warning"></i>
                            <a href="mailto:info@bpn.go.id" class="text-white-50 text-decoration-none">
                                info@bpn.go.id
                            </a>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-globe me-2 text-warning"></i>
                            <a href="https://www.bpn.go.id" target="_blank" class="text-white-50 text-decoration-none">
                                www.bpn.go.id
                            </a>
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-telephone me-2 text-warning"></i>
                            <span class="text-white-50">(021) 7393939</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <hr class="border-secondary">
            
            <!-- Copyright Row -->
            <div class="row">
                <div class="col-md-6">
                    <p class="small text-white-50 mb-0">
                        <i class="bi bi-c-circle me-1"></i>
                        2026 WebGIS Kantor BPN Seluruh Indonesia. 
                        Hak Cipta Dilindungi Undang-Undang.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="small text-white-50 mb-0">
                        <i class="bi bi-calendar me-1"></i>
                        Data diperbarui: 
                        15 February 2026                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript Files - URUTAN FINAL -->
    <!-- 1. jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

    <!-- 2. Bootstrap Bundle (include Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 3. DataTables -->
    <script src="https://cdn.datatables.net/2.3.7/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.3.7/js/dataTables.bootstrap5.js"></script>

    <!-- 4. Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 5. Custom JS -->
    <script src="assets/js/main.js"></script>
    <!-- Load stats.js (HARUS setelah main.js) -->
    <script src="assets/js/stats.js"></script>
    <script src="assets/js/dataTableCustom.js"></script>
    <script src="assets/js/exportCSV.js"></script>
    <script src="assets/js/printTable.js"></script>

    <!-- 6. Inisialisasi -->
    <script>
        // Versi sederhana untuk menandai menu active
        document.addEventListener('DOMContentLoaded', function() {
            // Dapatkan URL saat ini
            const currentUrl = window.location.pathname;
            const currentPage = currentUrl.split('/').pop() || 'index.php';
            
            console.log('Current page:', currentPage); // Debug
        
            // Pilih semua link di navbar
            const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
            
            // Loop melalui setiap link
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                console.log(href);
                
                // Skip jika href kosong atau #
                if (!href || href === '#') return;
                
                // Hapus class active dari semua link
                link.classList.remove('active');
                
                // Cek apakah link ini sesuai dengan halaman saat ini
                if (href === currentPage || 
                    (currentPage === '' || currentPage === '/' || currentPage === 'home.php') && 
                    (href === '/' || href === 'index.php' || href === 'home.php')) {
                    link.classList.add('active');
                }
            });
            
            // Handle khusus untuk halaman admin
            if (currentPage === 'admin.php' || currentPage === 'admin') {
                const adminDropdown = document.getElementById('adminDropdown');
                if (adminDropdown) {
                    adminDropdown.classList.add('active');
                }
            }
        });
    </script>
    
    <!-- Update footer statistics - PERBAIKAN -->
    <script>
        // Fungsi untuk update statistik footer
        function updateFooterStats() {
            console.log('Updating footer stats...'); // Debug
            
            // Coba akses dari window object
            const offices = window.allOffices || [];
            
            // Update total offices
            const footerTotal = document.getElementById('footerTotalOffices');
            if (footerTotal) {
                const total = offices.length || 0;
                footerTotal.textContent = total;
                console.log('Total offices:', total);
            }
            
            // Update total provinces
            const footerProvinces = document.getElementById('footerTotalProvinces');
            if (footerProvinces) {
                let provincesCount = 0;
                if (offices.length > 0) {
                    const provinces = [...new Set(offices.map(office => office.province).filter(p => p))];
                    provincesCount = provinces.length;
                }
                footerProvinces.textContent = provincesCount;
                console.log('Total provinces:', provincesCount);
            }
        }

        // Jalankan saat DOM loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking for data...');
            updateFooterStats();
        });

        // Jalankan juga setelah semua script selesai (termasuk main.js)
        window.addEventListener('load', function() {
            console.log('Window loaded, updating footer stats...');
            updateFooterStats();
        });

        // Custom event listener jika data dimuat secara async
        document.addEventListener('officesDataLoaded', function(e) {
            console.log('Custom event received:', e.detail);
            updateFooterStats();
        });
    </script>

    <!-- Footer Stats - Gunakan script global -->
    <script>
        // Data fallback dari PHP
        window.phpOffices = [{"id":"BPN001","name":"Kantor Wilayah BPN Provinsi Aceh","address":"Lamgugob, Jl. Teuku Nyak Arief, Lamgugob, Aceh 24415","city":"Kota Banda Aceh","province":"Aceh","latitude":5.576359,"longitude":95.355722,"phone":"(0651)7551708","email":"-@bpn.go.id","type":"Kanwil","description":"Kantor Wilayah BPN Provinsi Aceh Republik Indonesia"},{"id":"BPN002","name":"Kantor Wilayah BPN Jawa Barat","address":"Jl. LLRE Martadinata No. 153","city":"Bandung","province":"Jawa Barat","latitude":-6.912024,"longitude":107.619125,"phone":"(022) 4203328","email":"kanwil.jabar@bpn.go.id","type":"Kanwil","description":"Kantor Wilayah BPN Provinsi Jawa Barat"},{"id":"BPN003","name":"Kantor Pertanahan Kota Bandung","address":"Jl. Aceh No. 53","city":"Bandung","province":"Jawa Barat","latitude":-6.9125,"longitude":107.6206,"phone":"(022) 4205678","email":"kantah.bandung@bpn.go.id","type":"Kantah","description":"Kantor Pertanahan Kota Bandung"},{"id":"BPN004","name":"Kantor Pertanahan Kota Jakarta Pusat","address":"Jl. Kramat Raya No. 132","city":"Jakarta Pusat","province":"DKI Jakarta","latitude":-6.186486,"longitude":106.834091,"phone":"(021) 31907445","email":"kantah.jakpus@bpn.go.id","type":"Kantah","description":"Kantor Pertanahan Kota Jakarta Pusat"},{"id":"BPN005","name":"Kantor Pusat BPN","address":"Jl. Sisingamangaraja No. 2, Kebayoran Baru","city":"Jakarta Selatan","province":"DKI Jakarta","latitude":-6.226595,"longitude":106.802216,"phone":"(021) 7393939","email":"pusat@bpn.go.id","type":"Pusat","description":"Kantor Pusat Badan Pertanahan Nasional Republik Indonesia"},{"id":"BPN006","name":"irwan","address":"Jl. Irigasi Blok Cobek RT\/RW 001\/004 Ds. Mulyasari Losari Cirebon","city":"Cirebon","province":"Jawa Barat","latitude":-6.135463,"longitude":102.2354,"phone":"087789066519","email":"irwan.codeir@gmail.com","type":"Kantah","description":"test deskripsi"}];

        // Pastikan window.allOffices tersedia
        window.allOffices = window.allOffices || window.phpOffices || [];
    </script>

    <script>
        // Variabel global untuk menyimpan data
        let currentOffices = [{"id":"BPN001","name":"Kantor Wilayah BPN Provinsi Aceh","address":"Lamgugob, Jl. Teuku Nyak Arief, Lamgugob, Aceh 24415","city":"Kota Banda Aceh","province":"Aceh","latitude":5.576359,"longitude":95.355722,"phone":"(0651)7551708","email":"-@bpn.go.id","type":"Kanwil","description":"Kantor Wilayah BPN Provinsi Aceh Republik Indonesia"},{"id":"BPN002","name":"Kantor Wilayah BPN Jawa Barat","address":"Jl. LLRE Martadinata No. 153","city":"Bandung","province":"Jawa Barat","latitude":-6.912024,"longitude":107.619125,"phone":"(022) 4203328","email":"kanwil.jabar@bpn.go.id","type":"Kanwil","description":"Kantor Wilayah BPN Provinsi Jawa Barat"},{"id":"BPN003","name":"Kantor Pertanahan Kota Bandung","address":"Jl. Aceh No. 53","city":"Bandung","province":"Jawa Barat","latitude":-6.9125,"longitude":107.6206,"phone":"(022) 4205678","email":"kantah.bandung@bpn.go.id","type":"Kantah","description":"Kantor Pertanahan Kota Bandung"},{"id":"BPN004","name":"Kantor Pertanahan Kota Jakarta Pusat","address":"Jl. Kramat Raya No. 132","city":"Jakarta Pusat","province":"DKI Jakarta","latitude":-6.186486,"longitude":106.834091,"phone":"(021) 31907445","email":"kantah.jakpus@bpn.go.id","type":"Kantah","description":"Kantor Pertanahan Kota Jakarta Pusat"},{"id":"BPN005","name":"Kantor Pusat BPN","address":"Jl. Sisingamangaraja No. 2, Kebayoran Baru","city":"Jakarta Selatan","province":"DKI Jakarta","latitude":-6.226595,"longitude":106.802216,"phone":"(021) 7393939","email":"pusat@bpn.go.id","type":"Pusat","description":"Kantor Pusat Badan Pertanahan Nasional Republik Indonesia"},{"id":"BPN006","name":"irwan","address":"Jl. Irigasi Blok Cobek RT\/RW 001\/004 Ds. Mulyasari Losari Cirebon","city":"Cirebon","province":"Jawa Barat","latitude":-6.135463,"longitude":102.2354,"phone":"087789066519","email":"irwan.codeir@gmail.com","type":"Kantah","description":"test deskripsi"}];

        // Fungsi search tabel
        function searchTable() {
            const searchText = document.getElementById('tableSearch').value.toLowerCase();
            const provinceFilter = document.getElementById('provinceFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filterTableData(searchText, provinceFilter, typeFilter);
        }

        // Fungsi filter tabel
        function filterTable() {
            const searchText = document.getElementById('tableSearch').value.toLowerCase();
            const provinceFilter = document.getElementById('provinceFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filterTableData(searchText, provinceFilter, typeFilter);
        }

        // Fungsi filter data
        function filterTableData(searchText, province, type) {
            const filtered = currentOffices.filter(office => {
                // Filter pencarian
                const matchesSearch = searchText === '' || 
                    office.name.toLowerCase().includes(searchText) ||
                    office.address.toLowerCase().includes(searchText) ||
                    office.city.toLowerCase().includes(searchText) ||
                    office.province.toLowerCase().includes(searchText);
                
                // Filter provinsi
                const matchesProvince = province === '' || office.province === province;
                
                // Filter tipe
                const matchesType = type === '' || office.type === type;
                
                return matchesSearch && matchesProvince && matchesType;
            });
            
            displayFilteredData(filtered);
        }

        // Tampilkan data yang sudah difilter
        function displayFilteredData(filtered) {
            const tbody = document.getElementById('tableBody');
            const displayCount = document.getElementById('displayCount');
            const totalCount = document.getElementById('totalCount');
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-search fs-1 d-block text-muted mb-3"></i>
                            <h5 class="text-muted">Tidak ada data yang cocok</h5>
                            <p class="text-muted">Coba kata kunci atau filter lain</p>
                        </td>
                    </tr>
                `;
            } else {
                let html = '';
                filtered.forEach((office, index) => {
                    html += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td><small class="text-muted">${office.id}</small></td>
                            <td>
                                <strong>${escapeHtml(office.name)}</strong>
                                ${office.description ? `<br><small class="text-muted">${escapeHtml(office.description.substring(0, 50))}...</small>` : ''}
                            </td>
                            <td><i class="bi bi-geo-alt me-1 text-primary"></i>${escapeHtml(office.address)}</td>
                            <td>${escapeHtml(office.city)}</td>
                            <td>${escapeHtml(office.province)}</td>
                            <td>${office.phone ? `<i class="bi bi-telephone me-1 text-success"></i>${office.phone}` : '-'}</td>
                            <td>
                                <span class="badge ${getTypeClass(office.type)}">
                                    ${office.type}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick='editOffice(${JSON.stringify(office)})'>
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick='viewOffice(${JSON.stringify(office)})'>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteOffice('${office.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            }
            
            displayCount.textContent = filtered.length;
            totalCount.textContent = currentOffices.length;
        }

        // Escape HTML untuk keamanan
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Get class untuk badge tipe
        function getTypeClass(type) {
            switch(type) {
                case 'Kanwil': return 'bg-danger';
                case 'Pusat': return 'bg-warning text-dark';
                case 'Kantah': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        // Reset filter tabel
        function resetTableFilters() {
            document.getElementById('tableSearch').value = '';
            document.getElementById('provinceFilter').value = '';
            document.getElementById('typeFilter').value = '';
            displayFilteredData(currentOffices);
        }

        // Refresh tabel
        function refreshTable() {
            location.reload();
        }


        // View office details
        function viewOffice(office) {
            document.getElementById('viewId').textContent = office.id;
            document.getElementById('viewName').textContent = office.name;
            
            const viewType = document.getElementById('viewType');
            viewType.textContent = office.type;
            viewType.className = `badge ${getTypeClass(office.type)}`;
            
            document.getElementById('viewAddress').textContent = office.address;
            document.getElementById('viewCity').textContent = office.city;
            document.getElementById('viewProvince').textContent = office.province;
            document.getElementById('viewPhone').textContent = office.phone || '-';
            document.getElementById('viewEmail').textContent = office.email || '-';
            document.getElementById('viewLat').textContent = office.latitude;
            document.getElementById('viewLng').textContent = office.longitude;
            document.getElementById('viewDescription').textContent = office.description || '-';
            
            new bootstrap.Modal(document.getElementById('viewOfficeModal')).show();
        }

        // View on map (redirect ke halaman utama)
        function viewOnMap() {
            window.location.href = '/';
        }

        // Inisialisasi tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

    <script>
        // ============================================
        // FUNGSI MENAMPILKAN DETAIL KANTOR DI MODAL
        // ============================================
        window.showOfficeDetails = function (office) {
        console.log("showOfficeDetails dipanggil dengan:", office);

        // üî¥ YANG PALING PENTING: SIMPAN OFFICE YANG DIPILIH
        window.selectedOfficeForRoute = office;

        // Isi data modal
        const titleEl = document.getElementById("officeModalTitle");
        const addressEl = document.getElementById("officeAddress");
        const phoneEl = document.getElementById("officePhone");
        const emailEl = document.getElementById("officeEmail");
        const hoursEl = document.getElementById("officeHours");

        if (titleEl) titleEl.textContent = office.name || "-";
        if (addressEl) addressEl.textContent = office.address || "-";
        if (phoneEl) phoneEl.textContent = office.phone || "-";
        if (emailEl) emailEl.textContent = office.email || "-";
        if (hoursEl) hoursEl.textContent = office.jam_operasional || "08:00 - 16:00";

        // Hapus mini map lama jika ada
        if (window.miniMap) {
            window.miniMap.remove();
            window.miniMap = null;
        }

        // Buat mini map baru
        setTimeout(() => {
            const miniMapDiv = document.getElementById("officeMiniMap");
            if (miniMapDiv && office.latitude && office.longitude) {
            window.miniMap = L.map("officeMiniMap").setView(
                [office.latitude, office.longitude],
                15,
            );
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "¬© OpenStreetMap",
            }).addTo(window.miniMap);

            L.marker([office.latitude, office.longitude])
                .addTo(window.miniMap)
                .bindPopup(office.name)
                .openPopup();
            }
        }, 200);

        // Tampilkan modal
        const modalElement = document.getElementById("officeModal");
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        // Log untuk verifikasi
        console.log(
            "‚úÖ selectedOfficeForRoute setelah disimpan:",
            window.selectedOfficeForRoute,
        );
        };

        // ============================================
        // FUNGSI HANDLE RUTE
        // ============================================
        window.handleModalRouteClick = function () {
        console.log("handleModalRouteClick dipanggil");
        console.log("Isi selectedOfficeForRoute:", window.selectedOfficeForRoute);

        // Cek apakah ada office yang dipilih
        if (!window.selectedOfficeForRoute) {
            alert("‚ùå Pilih kantor terlebih dahulu dengan mengklik MARKER di peta!");
            return;
        }

        const office = window.selectedOfficeForRoute;
        console.log("‚úÖ Membuka rute ke:", office.name);

        // Cek geolocation
        if (!navigator.geolocation) {
            alert("Geolocation tidak didukung");
            window.open(
            `https://www.openstreetmap.org/?mlat=${office.latitude}&mlon=${office.longitude}#map=15/${office.latitude}/${office.longitude}`,
            "_blank",
            );
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function (position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;

            const url = `https://www.openstreetmap.org/directions?engine=graphhopper_foot&route=${userLat},${userLng};${office.latitude},${office.longitude}`;
            console.log("Membuka URL:", url);
            window.open(url, "_blank");
            },
            function (error) {
            console.error("Geolocation error:", error);
            alert("Gagal mendapatkan lokasi. Membuka peta kantor.");
            window.open(
                `https://www.openstreetmap.org/?mlat=${office.latitude}&mlon=${office.longitude}#map=15/${office.latitude}/${office.longitude}`,
                "_blank",
            );
            },
        );
        };

        // Di fungsi pembuatan marker
        function addOfficeMarker(office) {
        const marker = L.marker([office.latitude, office.longitude]).addTo(map);

        marker.on("click", function () {
            console.log("Marker diklik:", office.name);
            window.showOfficeDetails(office); // üî¥ PANGGIL FUNGSI INI
        });

        return marker;
        }

    </script>

<!-- get current location -->
    <script>

        // Get current location
        // ============================================
        // FUNGSI GET CURRENT LOCATION - VERSI OPTIMAL
        // ============================================
        window.getCurrentLocation = function () {
          console.log("getCurrentLocation dipanggil");

          if (!navigator.geolocation) {
            alert("Geolocation tidak didukung oleh browser Anda.");
            return;
          }

          // Tampilkan loading indicator
          const locateBtn = document.getElementById("locateBtn");
          const originalHtml = locateBtn ? locateBtn.innerHTML : "";
          if (locateBtn) {
            locateBtn.innerHTML =
              '<span class="spinner-border spinner-border-sm"></span>';
            locateBtn.disabled = true;
          }

          // Opsi untuk mendapatkan lokasi AKURAT
          const options = {
            enableHighAccuracy: true, // PAKSA GPS, bukan WiFi/IP [citation:1][citation:8]
            timeout: 10000, // Tunggu maksimal 10 detik [citation:4]
            maximumAge: 0, // Jangan pakai cache, selalu baru [citation:2]
          };

          navigator.geolocation.getCurrentPosition(
            // SUCCESS CALLBACK
            function (position) {
              console.log("Lokasi ditemukan:", position);

              const latitude = position.coords.latitude;
              const longitude = position.coords.longitude;
              const accuracy = position.coords.accuracy; // Akurasi dalam meter

              console.log(
                `Koordinat: ${latitude}, ${longitude}, Akurasi: ${accuracy}m`,
              );

              // Reset button
              if (locateBtn) {
                locateBtn.innerHTML = originalHtml;
                locateBtn.disabled = false;
              }

              // Hapus marker lama
              if (window.currentLocationMarker) {
                map.removeLayer(window.currentLocationMarker);
              }
              if (window.currentAccuracyCircle) {
                map.removeLayer(window.currentAccuracyCircle);
              }

              // BUAT LINGKARAN AKURASI - biar tahu seberapa akurat [citation:1]
              window.currentAccuracyCircle = L.circle([latitude, longitude], {
                radius: accuracy, // Radius = akurasi dalam meter
                color: "#3388ff",
                weight: 1,
                fillColor: "#3388ff",
                fillOpacity: 0.1,
              }).addTo(map);

              // BUAT MARKER LOKASI
              window.currentLocationMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                  className: "current-location-marker",
                  html: '<div style="width: 20px; height: 20px; background-color: #4285F4; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(66,133,244,0.5);"></div>',
                  iconSize: [20, 20],
                  iconAnchor: [10, 10],
                }),
              })
                .addTo(map)
                .bindPopup(
                  `Lokasi Anda Saat Ini<br><small>Akurasi: ${accuracy} meter</small>`,
                )
                .openPopup();

              // TAMPILKAN PERINGATAN JIKA AKURASI BURUK [citation:1]
              if (accuracy > 100) {
                alert(
                  `Akurasi lokasi rendah (${accuracy}m). Pastikan GPS aktif dan Anda di luar ruangan.`,
                );
              }

              // Pusatkan peta ke lokasi
              map.setView([latitude, longitude], 15);
            },

            // ERROR CALLBACK
            function (error) {
              console.error("Geolocation error:", error);

              // Reset button
              if (locateBtn) {
                locateBtn.innerHTML = originalHtml;
                locateBtn.disabled = false;
              }

              let errorMessage = "Tidak dapat mendapatkan lokasi Anda: ";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage +=
                    "Izin lokasi ditolak. Izinkan akses lokasi di browser.";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage += "Informasi lokasi tidak tersedia. Nyalakan GPS.";
                  break;
                case error.TIMEOUT:
                  errorMessage +=
                    "Waktu permintaan lokasi habis. Coba di tempat dengan sinyal lebih baik.";
                  break;
                default:
                  errorMessage += error.message;
              }

              alert(errorMessage);
            },
            options, // PAKAI OPTIONS YANG SUDAH DISET
          );
        };

    </script>
</body>
</html>